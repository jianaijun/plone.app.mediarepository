<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US"
      lang="en-US"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<body>

<div metal:fill-slot="content-core"
     tal:define="media view/queryMediaRepository;
                 allCount python:media.actual_result_count;
                 tags python:view.getSearchTagsFromResults(media);
                 requestTags python:[t for t in request.form.get('tags', []) if t];
                 allTags view/allTags;
                 tagdata python:{'tags': request.form.get('tags', [])};
                 batchformkeys python:['tags', 'SearchableText', 'b_active'];
                 dummy python:request.form.update({'b_active': 1});
                 Batch python:modules['Products.CMFPlone'].Batch;
                 b_start python:request.get('b_start', 0);
                 b_size view/b_size;
                 batch python:Batch(media, b_size, int(b_start), orphan=view.b_orphan);
                 toLocalizedTime nocall:context/@@plone/toLocalizedTime;
                 normalizeString nocall:context/@@plone/normalizeString;
                 portal_membership context/@@plone_tools/membership;
                 getMemberInfo nocall:portal_membership/getMemberInfo;">

<script type="text/javascript" charset="utf-8">
    jQuery(function($) {
        $().ready(function () {
            $("#media-tag-filter").change(function() {
                $("#filter-form").submit();
            });

            $(".media-tag-remove").click(function() {
                $(this).parent().find("input[type='hidden']").remove();
                $("#filter-form").submit();
                return false;
            });

            $(".media-text-remove").click(function() {
                $("input[name='SearchableText']").val("");
                $("#filter-form").submit();
                return false;
            });

            $('.imagePreview img').prepOverlay({
                subtype: 'image',
                urlmatch: '/@@images/.+$',
                urlreplace: ''
            });

            function enableSelectRest() {
                var selectRest = $("#mediarepo-select-rest");
                if(selectRest.length > 0) {
                  selectRest.show();
                  $("#select-rest-marker").val("");
                  $("#mediarepo-selected-rest-count").hide();
                }
            }

            function disableSelectRest() {
                var selectRest = $("#mediarepo-select-rest");
                if(selectRest.length > 0) {
                  selectRest.hide();
                  $("#select-rest-marker").val("");
                  $("#mediarepo-selected-rest-count").hide();
                }
            }

            $("#mediarepo-select-all").click(function () {
                $(".itemcheckbox").attr('checked', true);

                $("#mediarepo-select-none").show();
                $(this).hide();
                enableSelectRest();

                return false;
            });

            $("#mediarepo-select-none").click(function () {
                $(".itemcheckbox").attr('checked', false);

                $("#mediarepo-select-all").show();
                $(this).hide();
                disableSelectRest();

                return false;
            });

            $("#mediarepo-select-rest").click(function () {

                $("#select-rest-marker").val("1");

                $("#mediarepo-selected-rest-count").show();
                $("#mediarepo-select-all").hide();
                $("#mediarepo-select-none").show();
                $(this).hide();

                return false;
            });

            var numCheckboxes = $(".itemcheckbox").length;
            $(".itemcheckbox").change(function() {

                var numChecked = $(".itemcheckbox:checked").length;

                // Control the 'All' button
                if(numChecked < numCheckboxes) { // Unchecked at least one
                   $("#mediarepo-select-all").show();
                   disableSelectRest();

                } else if(numChecked == numCheckboxes) { // Checked everything
                    $("#mediarepo-select-all").hide();
                    enableSelectRest();
                }

                // Control the 'None' button
                if(numChecked > 0) { // Checked at least one
                    $("#mediarepo-select-none").show();
                } else if(numChecked == 0) { // Checked none
                    $("#mediarepo-select-none").hide();
                }

            });


        });
    });
</script>

  <h2 i18n:translate="title_edit_bulk">Bulk operations</h2>

  <p class="discreet" i18n:translate="description_media_bulk_operations">
    Use the table below to modify tags or delete media items in bulk. You
    can use the tags filter to restrict the items to work on.
  </p>

    <form id="filter-form" method="post" tal:attributes="action string:${request/getURL}">

      <div style="float: right; clear: right">
        <input name="SearchableText"
               type="text"
               size="18"
               value=""
               title="Search media"
               placeholder="Search media"
               accesskey="4"
               i18n:attributes="title title_search_media_metadata;
                                placeholder title_search_media_metadata"
               tal:attributes="value request/form/SearchableText|nothing;"
               class="searchField" />

        <input class="searchButton allowMultiSubmit"
               type="submit"
               value="Search"
               i18n:attributes="value label_search;"/>

        <select name="tags:list" id="media-tag-filter" tal:condition="tags" style="display:block">
          <option value="" i18n:translate="label_only_these_tags">Only show items with tag&hellip;</option>
          <option value="__notags__"
                  i18n:translate="label_no_tags"
                  tal:condition="not:requestTags"
                  >[no tags]</option>
          <option
                i18n:translate=""
                tal:repeat="tag tags"
                tal:content="tag"
                tal:attributes="value tag"
                />
        </select>
      </div>

      <div tal:condition="requestTags">
          <label i18n:translate="label_tag_filter">Tags filter:</label>
          <span tal:repeat="tag requestTags">
              <input
                type="hidden"
                name="tags:list"
                tal:attributes="value tag; id string:filter-tag-${tag}"
                />
              <span
                tal:condition="python:tag != '__notags__'"
                tal:content="tag"
                />
              <span
                tal:condition="python:tag == '__notags__'"
                i18n:translate="label_no_tags"
                >[no tags]</span>
              <a href="#"
                 class="media-tag-remove"
                 title="Remove this tag from search">(-)</a>
              <tal:arrow tal:condition="not:repeat/tag/end">
                  &rarr;
              </tal:arrow>
          </span>
      </div>
      <div tal:condition="request/SearchableText | nothing">
          <label i18n:translate="label_search_filter">Text filter:</label>
          <span>
              <span tal:content="request/SearchableText" />
              <a href="#"
                 class="media-text-remove"
                 title="Remove this filter from search">(-)</a>
          </span>
      </div>

      <div class="visualClear"><!-- --></div>

      <table class="listing">
        <thead>
          <tr>
            <th colspan="5" class="nosort" align="left">
              <span i18n:translate="label_select" tal:omit-tag="">Select:</span>
              <a i18n:translate="label_all"
                 id="mediarepo-select-all"
                 href="#"
                 class="update-selection">All</a>
              <a i18n:translate="label_none"
                 href="#"
                 style="display:none"
                 id="mediarepo-select-none"
                 class="update-selection">None</a>
              <a i18n:translate="label_select_rest"
                 style="display:none"
                 href="#"
                 id="mediarepo-select-rest"
                 tal:condition="python: view.b_size &lt; len(media)">
                 Select all <span i18n:name="count" tal:omit-tag="" tal:content="allCount" /> matching items
              </a>
              <span id="mediarepo-selected-rest-count" i18n:translate="label_selected_rest_count" style="display: none">
                All <span i18n:name="count" tal:omit-tag="" tal:content="allCount" /> matching items selected
              </span>
            </th>
          </tr>
          <tr>
            <th class="nosort">&nbsp;</th>
            <th class="nosort">Thumbnail</th>
            <th class="nosort">Tags</th>
            <th class="nosort">Title</th>
            <th class="nosort">Author</th>
          </tr>
        </thead>
        <tbody>
          <tal:items tal:repeat="item batch">
            <tr tal:define="oddrow repeat/item/odd;"
                tal:attributes="class python:oddrow and 'even' or 'odd'">
              <td>
                <input type="checkbox"
                       class="itemcheckbox noborder"
                       name="paths:list" id="#"
                       value="#"
                       tal:attributes="value   item/getPath;
                                       id      string:cb_${item/getId};
                                       checked python:request.get('ids_checked', False) and 'checked' or None;
                                       alt     string:Select ${item/pretty_title_or_id};
                                       title   string:Select ${item/pretty_title_or_id}" />
              </td>
              <td class="imagePreview" tal:define="obj item/getObject">
                <img tal:replace="structure obj/@@images/image/tile | nothing" />
              </td>
              <td tal:content="python:', '.join(item.Subject)">
                  Tag
              </td>
              <td>
                <tal:title tal:content="item/Title"> Item Title </tal:title>
              </td>
              <td>
                <tal:creators tal:repeat="creator item/listCreators">
                    <tal:name tal:condition="creator"
                              tal:define="author python:getMemberInfo(creator)">
                        <div tal:content="python:author and author['fullname'] or creator">
                            Bob Dobalina
                        </div>
                    </tal:name>
                </tal:creators>
              </td>
            </tr>
          </tal:items>
        </tbody>
      </table>

      <tal:block condition="media" metal:use-macro="context/batch_macros/macros/navigation" />

      <input type="hidden" id="select-rest-marker" name="selectRest:boolean" value="" />

      <div id="tag-controls">

        <div class="field">
          <label for="" i18n:translate="label_remove_tags">Remove tags</label>
          <div class="formHelp" i18n:translate="help_remove_tags">
            The tags below are used in at least one of the matched media items.
            Select one or more items below and then select one or more tags below and
            click <strong>Update</strong> to remove these tags from the selected items.
          </div>
          <select name="removeTags:list" multiple="multiple" size="5">
            <tal:block repeat="tag allTags">
              <option
                tal:condition="tag"
                tal:attributes="value tag"
                tal:content="tag"
                />
            </tal:block>
          </select>
        </div>

        <div class="field">
          <label for="" i18n:translate="label_add_tags">Add tags</label>
          <div class="formHelp" i18n:translate="help_add_tags">
            To add new tags to the selected items, you can either choose from
            a list of tags currently in use, or add new tags (one per line), then
            click <strong>Update</strong>.
          </div>

          <select name="addTags:list" multiple="multiple" style="float: left; margin: 0 1em 0 0; height: 6em;">
            <tal:block repeat="tag allTags">
              <option
                tal:condition="python:tag not in requestTags"
                tal:attributes="value tag"
                tal:content="tag"
                />
            </tal:block>
          </select>

          <textarea style="width: 40%; height: 5em; margin: 0;" name="newTags:lines" rows="5" cols="30"></textarea>


        </div>

      </div>

      <div class="formControls">

          <input class="context"
                 type="submit"
                 value="Update"
                 name="form.button.Update"
                 i18n:attributes="value label_update;"
                 />

          <input class="destructive"
                 type="submit"
                 value="Delete"
                 name="form.button.Delete"
                 tal:condition="view/canDelete"
                 i18n:attributes="value label_delete;"
                 />

      </div>

    </form>

</div>

</body>
</html>
